#!/bin/bash

# Lyra Analysis Script
# Usage: lyra-analyze REPO_PATH

if [ $# -eq 0 ]; then
    echo "Usage: lyra-analyze REPO_PATH"
    exit 1
fi

REPO_PATH="$1"

if [ ! -d "$REPO_PATH" ]; then
    echo "Error: Directory $REPO_PATH does not exist"
    exit 1
fi

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Template prompt for Claude Code
PROMPT="ğŸ¼ Lyra's Performance Symphony Analyzer ğŸ¼

Like Orpheus descending into the underworld to retrieve Eurydice, I shall dive deep into the performance depths of your training pipeline at $REPO_PATH to bring back insights! ğŸ­âš¡

Use the profiler_analyzer.py script at $SCRIPT_DIR/profiler_analyzer.py as your mystical lyre to help with analysis.

ğŸŒŸ **Constellation I: Existing Profiling Setup** ğŸŒŸ
Search through the starlit code for profiler configurations, timing melodies, or performance monitoring:
   ğŸµ PyTorch Lightning Profiler configurations
   ğŸµ Custom timing/profiling decorators
   ğŸµ Performance logging statements
   ğŸµ Profiler report files (*.prof, *.trace, etc.)

â­ **Constellation II: Training Pipeline Analysis** â­
Identify celestial components that could benefit from the lyre's profiling touch:
   ğŸ¶ DataLoader and data preprocessing steps
   ğŸ¶ Model forward/backward passes
   ğŸ¶ Optimizer steps and gradient computations
   ğŸ¶ Callback functions and hooks
   ğŸ¶ I/O operations and checkpointing

ğŸŒŒ **Constellation III: Performance Bottleneck Indicators** ğŸŒŒ
Look for discordant notes in the performance symphony:
   âœ¨ Large dataset loading without optimization
   âœ¨ Complex data transformations
   âœ¨ Inefficient model architectures
   âœ¨ Memory-intensive operations
   âœ¨ Synchronous I/O operations

ğŸ¯ **Constellation IV: Profiling Recommendations** ğŸ¯
Suggest specific harmonization strategies:
   ğŸ¼ Where to add PyTorch Lightning profiler
   ğŸ¼ Which components need detailed timing analysis
   ğŸ¼ Memory profiling opportunities
   ğŸ¼ GPU utilization monitoring points

ğŸ­ For each melodic finding, please provide:
ğŸµ File locations with line numbers
ğŸµ Code snippets showing current implementation
ğŸµ Specific profiling recommendations
ğŸµ Expected bottlenecks to investigate

ğŸŒŸ If you find existing profiler reports in the repository, use the profiler_analyzer.py script like Orpheus's lyre to analyze them and provide bottleneck analysis.

ğŸ¶ Generate a comprehensive performance symphony report with actionable recommendations for optimizing the training pipeline. Let the music of optimization begin! ğŸ¼âœ¨"

# Run Claude Code with the prompt
cd "$REPO_PATH" && claude --message "$PROMPT"