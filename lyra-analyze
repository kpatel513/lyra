#!/bin/bash

# Lyra Analysis Script
# Usage: lyra-analyze REPO_PATH

if [ $# -eq 0 ]; then
    echo "Usage: lyra-analyze REPO_PATH"
    exit 1
fi

REPO_PATH="$1"

if [ ! -d "$REPO_PATH" ]; then
    echo "Error: Directory $REPO_PATH does not exist"
    exit 1
fi

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Lyra will use a temporary file for the prompt to avoid shell escaping issues

# Display progress information
echo "ðŸŽ¼ Lyra Performance Analysis Starting..."
echo "ðŸ“‚ Repository: $REPO_PATH"
echo ""
echo "ðŸŒŸ Constellation I: Scanning for existing profiling configurations..."
echo "â­ Constellation II: Mapping training pipeline components..."
echo "ðŸŒŒ Constellation III: Detecting performance bottleneck indicators..."
echo "ðŸŽ¼ Constellation IV: Composing profiling recommendations..."
echo ""
echo "ðŸŽ­ Orpheus descends into the performance depths of your training pipeline..."
echo "   This journey may take 1-3 minutes depending on code complexity..."
echo ""

# Run Claude Code with the prompt using a temporary file to avoid shell escaping issues
TEMP_PROMPT_FILE=$(mktemp)
cat > "$TEMP_PROMPT_FILE" << 'EOF'
ðŸŽ¼ Lyra's Performance Symphony Analyzer ðŸŽ¼

Like Orpheus descending into the underworld to retrieve Eurydice, I shall dive deep into the performance depths of your training pipeline to bring back insights! ðŸŽ­âš¡

ðŸŒŸ **Constellation I: Existing Profiling Setup** ðŸŒŸ
Search through the starlit code for profiler configurations, timing melodies, or performance monitoring:
   ðŸŽµ PyTorch Lightning Profiler configurations
   ðŸŽµ Custom timing/profiling decorators
   ðŸŽµ Performance logging statements
   ðŸŽµ Profiler report files (*.prof, *.trace, etc.)

â­ **Constellation II: Training Pipeline Analysis** â­
Identify celestial components that could benefit from the lyre's profiling touch:
   ðŸŽ¶ DataLoader and data preprocessing steps
   ðŸŽ¶ Model forward/backward passes
   ðŸŽ¶ Optimizer steps and gradient computations
   ðŸŽ¶ Callback functions and hooks
   ðŸŽ¶ I/O operations and checkpointing

ðŸŒŒ **Constellation III: Performance Bottleneck Indicators** ðŸŒŒ
Look for discordant notes in the performance symphony:
   âœ¨ Large dataset loading without optimization
   âœ¨ Complex data transformations
   âœ¨ Inefficient model architectures
   âœ¨ Memory-intensive operations
   âœ¨ Synchronous I/O operations

ðŸŽ¼ **Constellation IV: Profiling Recommendations** ðŸŽ¼
Suggest specific harmonization strategies:
   ðŸŽ¼ Where to add PyTorch Lightning profiler
   ðŸŽ¼ Which components need detailed timing analysis
   ðŸŽ¼ Memory profiling opportunities
   ðŸŽ¼ GPU utilization monitoring points

ðŸŽ­ For each melodic finding, please provide:
ðŸŽµ File locations with line numbers
ðŸŽµ Code snippets showing current implementation
ðŸŽµ Specific profiling recommendations
ðŸŽµ Expected bottlenecks to investigate

ðŸŽ¶ Generate a comprehensive performance symphony report with actionable recommendations for optimizing the training pipeline. Let the music of optimization begin! ðŸŽ¼âœ¨
EOF

if cd "$REPO_PATH" && claude --print "$(cat "$TEMP_PROMPT_FILE")"; then
    rm -f "$TEMP_PROMPT_FILE"
    # Display completion message
    echo ""
    echo "ðŸŽ¶âœ¨ Performance symphony analysis complete! Your optimization harmonies await above."
else
    rm -f "$TEMP_PROMPT_FILE"
    echo ""
    echo "âŒ Error: Claude Code analysis failed. This could be due to:"
    echo "   â€¢ Claude Code authentication issues"
    echo "   â€¢ Network connectivity problems"
    echo "   â€¢ Repository size or complexity"
    echo "   â€¢ Insufficient permissions"
    echo ""
    echo "ðŸ”§ Troubleshooting suggestions:"
    echo "   1. Check Claude Code authentication: claude config"
    echo "   2. Try with a smaller test repository"  
    echo "   3. Ensure stable internet connection"
    echo "   4. Check repository permissions"
    exit 1
fi