#!/bin/bash

# Lyra Environment Setup Script
# Usage: lyra-setup REPO_PATH [ENVIRONMENT_NAME]
# This script handles the environment setup phase for Lyra profiling

if [ $# -eq 0 ]; then
    echo "Usage: lyra-setup REPO_PATH [ENVIRONMENT_NAME]"
    echo ""
    echo "Arguments:"
    echo "  REPO_PATH         Path to the ML repository"
    echo "  ENVIRONMENT_NAME  Optional: Custom name for the profiling environment"
    echo ""
    echo "Examples:"
    echo "  lyra-setup ~/my-project                    # Auto-generate environment name"
    echo "  lyra-setup ~/my-project my-custom-env     # Use custom environment name"
    exit 1
fi

REPO_PATH="$1"
ENVIRONMENT_NAME="${2:-lyra-profile-$(date +%s)}"

if [ ! -d "$REPO_PATH" ]; then
    echo "Error: Directory $REPO_PATH does not exist"
    exit 1
fi

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Template prompt for Claude Code - Environment Setup Phase
PROMPT="ğŸ¼ Lyra's Environment Setup - Orpheus's Celestial Preparation ğŸ¼

Like Orpheus preparing the sacred grove for his performance, I shall create the perfect environment for safe profiling at $REPO_PATH! ğŸ­âœ¨

ğŸŒŸ **Environment Name**: $ENVIRONMENT_NAME

ğŸµ **Phase I: Environment Setup** ğŸµ
Prepare the celestial environment for safe profiling:
   â­ Detect environment configuration files (requirements.txt, environment.yml, pyproject.toml, etc.)
   â­ Create isolated profiling environment (conda/venv) with name: '$ENVIRONMENT_NAME'
   â­ Install all dependencies from repository's configuration files
   â­ Verify environment setup and required packages are available
   â­ Handle different package managers (pip, conda, poetry, pipenv)

ğŸ¼ **Environment Setup Strategy:** ğŸ¼
Handle common environment configurations:
   ğŸ¶ requirements.txt â†’ pip install -r requirements.txt
   ğŸ¶ environment.yml/environment.yaml â†’ conda env create -f environment.yml
   ğŸ¶ pyproject.toml â†’ poetry install or pip install -e .
   ğŸ¶ Pipfile â†’ pipenv install
   ğŸ¶ setup.py â†’ pip install -e .
   ğŸ¶ Docker configurations â†’ Analyze Dockerfile for dependencies
   ğŸ¶ README instructions â†’ Parse installation commands

ğŸ­ **Implementation Requirements:** ğŸ­
1. **Environment Isolation**: Create isolated environment to avoid conflicts with user's setup
2. **Safety First**: Never permanently modify user's configuration files
3. **Automated**: Handle environment setup and dependency installation automatically
4. **Comprehensive**: Install all required dependencies for the training pipeline
5. **Validation**: Verify successful environment creation and package installation
6. **Documentation**: Provide clear instructions for environment activation and usage

âš¡ **Expected Output:** âš¡
   ğŸŒŸ Successfully created and configured isolated environment: $ENVIRONMENT_NAME
   ğŸŒŸ All dependencies installed and verified
   ğŸŒŸ Environment activation instructions
   ğŸŒŸ List of installed packages and versions
   ğŸŒŸ Path to environment and activation script

ğŸ¼ Execute this environment setup workflow and prepare the perfect celestial stage for profiling! ğŸ¼âœ¨

After environment setup is complete, provide:
ğŸµ Environment name and location
ğŸµ Activation command for the environment
ğŸµ List of installed packages
ğŸµ Verification that all dependencies are satisfied
ğŸµ Instructions for using this environment with lyra-profile"

# Display progress information
echo "ğŸ¼ Lyra Environment Setup Starting..."
echo "ğŸ“‚ Repository: $REPO_PATH"
echo "ğŸŒŒ Environment: $ENVIRONMENT_NAME"
echo ""
echo "ğŸµ Detecting configuration files..."
echo "ğŸ¶ Creating isolated environment..."
echo "ğŸ­ Installing dependencies..."
echo "ğŸŒŸ Verifying environment setup..."
echo ""
echo "ğŸ­ Orpheus prepares the sacred grove for the performance ahead..."
echo "   Environment setup may take 2-5 minutes depending on dependencies..."
echo ""

# Run Claude Code with the prompt
cd "$REPO_PATH" && claude --print "$PROMPT"

# Display completion message
echo ""
echo "ğŸ¼âœ¨ Environment setup symphony complete! Your celestial stage is ready for profiling."