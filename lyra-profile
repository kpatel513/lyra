#!/bin/bash

# Lyra Profiler Script - Safe Mode Training Profiler
# Usage: lyra-profile REPO_PATH [TRAINING_SCRIPT]

if [ $# -eq 0 ]; then
    echo "Usage: lyra-profile REPO_PATH [TRAINING_SCRIPT]"
    echo ""
    echo "Arguments:"
    echo "  REPO_PATH        Path to the ML repository"
    echo "  TRAINING_SCRIPT  Optional: Specific training script to profile (e.g., train.py, scripts/train_model.py)"
    echo ""
    echo "Examples:"
    echo "  lyra-profile ~/my-project                    # Auto-detect training script"
    echo "  lyra-profile ~/my-project train.py          # Profile specific script"
    echo "  lyra-profile ~/my-project scripts/train.py  # Profile script in subdirectory"
    exit 1
fi

REPO_PATH="$1"
TRAINING_SCRIPT="${2:-}"

if [ ! -d "$REPO_PATH" ]; then
    echo "Error: Directory $REPO_PATH does not exist"
    exit 1
fi

# If training script is specified, validate it exists
if [ -n "$TRAINING_SCRIPT" ]; then
    FULL_SCRIPT_PATH="$REPO_PATH/$TRAINING_SCRIPT"
    if [ ! -f "$FULL_SCRIPT_PATH" ]; then
        echo "Error: Training script $TRAINING_SCRIPT does not exist in $REPO_PATH"
        exit 1
    fi
fi

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Template prompt for Claude Code
PROMPT="ğŸ¼ Lyra's Safe Mode Profiler - Orpheus's Training Harmonizer ğŸ¼

Like Orpheus carefully tuning his lyre before the performance, I shall prepare your training code at $REPO_PATH for safe profiling! ğŸ­âœ¨

$(if [ -n "$TRAINING_SCRIPT" ]; then echo "ğŸ¼ **Target Training Script**: $TRAINING_SCRIPT"; else echo "ğŸ” **Auto-Detection Mode**: I will search for and identify the main training script"; fi)

ğŸŒŸ **Mission: Transform Training Code into Safe Profiling Mode** ğŸŒŸ

I need to modify the training pipeline to run in safe mode with comprehensive profiling:

ğŸµ **Phase I: Environment Setup** ğŸµ
Prepare the celestial environment for safe profiling:
   â­ Detect environment configuration files (requirements.txt, environment.yml, pyproject.toml, etc.)
   â­ Create isolated profiling environment (conda/venv) with unique name like 'lyra-profile-[timestamp]'
   â­ Install all dependencies from repository's configuration files
   â­ Verify environment setup and required packages are available
   â­ Handle different package managers (pip, conda, poetry, pipenv)

ğŸ¶ **Phase II: Safe Mode Transformation** ğŸ¶
Transform the training code to prevent any permanent changes:
   ğŸŒŸ Disable all model saving and checkpointing
   ğŸŒŸ Prevent any permanent data rewriting or modification
   ğŸŒŸ Add backup/restore mechanisms for any temporary changes
   ğŸŒŸ Limit training loop to exactly 100 steps maximum
   ğŸŒŸ Add early stopping after profiling is complete

ğŸ­ **Phase III: Advanced Profiler Integration** ğŸ­
Add comprehensive PyTorch Lightning profiling capabilities:
   âœ¨ Integrate PyTorch Lightning's AdvancedProfiler
   âœ¨ Configure profiler to capture detailed timing information
   âœ¨ Set up profiler output to generate detailed reports
   âœ¨ Add memory profiling and GPU utilization tracking
   âœ¨ Configure profiler for training pipeline bottleneck analysis

ğŸŒŒ **Phase IV: Profiling Execution** ğŸŒŒ
Execute the safe profiling run in the prepared environment:
   ğŸ¼ Activate the isolated profiling environment
   ğŸ¼ Run the modified training code with profiler enabled
   ğŸ¼ Generate comprehensive profiler reports
   ğŸ¼ Capture timing data for all training components
   ğŸ¼ Save profiler output to lyra_profiler_report.txt

ğŸŒŸ **Phase V: Cleanup and Restoration** ğŸŒŸ
Clean up after profiling completion:
   ğŸµ Restore any temporarily modified files
   ğŸµ Deactivate and optionally remove the profiling environment
   ğŸµ Provide summary of profiling results and next steps

ğŸ­ **Implementation Requirements:** ğŸ­
1. **Environment Isolation**: Create isolated environment to avoid conflicts with user's setup
2. **Safety First**: Never permanently modify user's code or data
3. **Comprehensive**: Profile all major training components
4. **Automated**: Handle environment setup and dependency installation automatically
5. **Detailed**: Generate actionable profiler output
6. **Restorative**: Clean up all temporary modifications and environments

ğŸŒŒ **Search Strategy:** ğŸŒŒ
$(if [ -n "$TRAINING_SCRIPT" ]; then 
    echo "Focus on the specified training script: $TRAINING_SCRIPT"
    echo "   ğŸ¼ Analyze and modify the target script: $TRAINING_SCRIPT"
    echo "   ğŸ¼ Identify dependencies and imports used by this script"
    echo "   ğŸ¼ Configure profiler specifically for this training pipeline"
else
    echo "Auto-detect training entry points:"
    echo "   ğŸµ main training scripts (train.py, main.py, run.py)"
    echo "   ğŸµ PyTorch Lightning training modules"
    echo "   ğŸµ scripts/ or training/ directories"
    echo "   ğŸµ Configuration files indicating training entry points"
fi)
   ğŸµ DataLoader and model definitions
   ğŸµ Trainer initialization code

ğŸ¼ **Profiler Configuration Template:** ğŸ¼
Configure the profiler to capture:
   ğŸ¶ Function-level timing information
   ğŸ¶ Memory allocation patterns
   ğŸ¶ GPU utilization metrics
   ğŸ¶ Data loading bottlenecks
   ğŸ¶ Model forward/backward pass timing

âš¡ **Expected Output:** âš¡
Generate a detailed profiler report that lyra-analyze can process to identify:
   ğŸŒŸ Training pipeline bottlenecks
   ğŸŒŸ Memory inefficiencies
   ğŸŒŸ Data loading issues
   ğŸŒŸ Model computation hotspots
   ğŸŒŸ Optimization opportunities

ğŸ¼ **Environment Setup Strategy:** ğŸ¼
Handle common environment configurations:
   ğŸ¶ requirements.txt â†’ pip install -r requirements.txt
   ğŸ¶ environment.yml/environment.yaml â†’ conda env create -f environment.yml
   ğŸ¶ pyproject.toml â†’ poetry install or pip install -e .
   ğŸ¶ Pipfile â†’ pipenv install
   ğŸ¶ setup.py â†’ pip install -e .
   ğŸ¶ Docker configurations â†’ Analyze Dockerfile for dependencies
   ğŸ¶ README instructions â†’ Parse installation commands

ğŸ­ Execute this complete safe profiling workflow with environment setup and run the training with comprehensive profiling enabled. Let the performance symphony begin! ğŸ¼âœ¨

After profiling is complete, provide:
ğŸµ Details of environment created and packages installed
ğŸµ Path to generated profiler report
ğŸµ Summary of what was profiled
ğŸµ Any temporary modifications made and restored
ğŸµ Instructions for using lyra-analyze with the generated report
ğŸµ Environment cleanup status and instructions"

# Run Claude Code with the prompt
cd "$REPO_PATH" && claude --message "$PROMPT"